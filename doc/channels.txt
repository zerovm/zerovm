ZeroVM channels description
(up to date 2014-03-19, needs editing)
---------------------------

Channels are the key component of ZeroVM I/O subsystem. On the host system
side the channels are backed by the file system using regular files, pipes,
character devices or unix domain sockets. On the guest side the channel is
a device file. It could be used as either character or block device it depends
on the usage pattern and access type (see access types below). "Channel"
keyword passed via the manifest to ZeroVM (comma delimited, see examples
below). this keyword can (and should) be used more than once per manifest.
It is possible to use integers in octal, decimal and hexadecimal notation.

Channel = [uri], [alias], [type], [gets], [get_size], [puts], [put_size]
uri      - can be a local file, pipe, character device or node identifier
  (see more details below).
alias    - channel name for the user side.
type     - access type.
  0: sequential read / sequential write (can be used as character device)
  1: random read / sequential write
  2: sequential read / random write
  3: random read / random write
gets     - limit for reads allowed from this channel
get_size - limit on total amount of data to be read from this channel in bytes
puts     - limit for writes allowed for this channel
put_size - limit on total amount of data to be written to this channel in bytes

Fields available for the untrusted code (see api.txt):
limits -- 4 limits for the channel
size -- channel size. only available for random access channels
type -- access type
name -- the channel name (the alias from the manifest)
the indices in the channels array can be used as "handles". also it is
guaranteed that handles 0..2 represent /dev/stdin, /dev/stdout and /dev/stderr

For now ZeroVM supports 6 kinds of channels (defined by combination of
access type and 4 read/write limits):
- sequential read only channel (access type 0, both write limits are 0)
- random read only channel (access type 3, both write limits are 0)
- sequential write only channel (access type 0, both read limits are 0)
- random write only channel (access type 3, both read limits are 0)
- appendable channel. random read, sequential write. if the channel is not empty
  the write position is set next to the last byte (access type 1, any limits)
- full random access channel. can be read or written from any valid position
  (access type 3, any limits)

There are 3 mandatory channels (standard c90 streams): stdin, stdout, stdout.
The channels have well known device names "/dev/stdin", "/dev/stdout" and
"/dev/stderr". all mandatory channels must present in the manifest.
usually /dev/stdin is a sequential read only channel, /dev/stdin is a
sequential write only channel and /dev/stderr is a sequential write only 
channel. however standard channels access type can be redefined in the
system manifest (not recommended).

Channel is a file abstraction over the local files and network streams. Local 
files can have random access type, network streams are always sequential.

All channels are opened before the session start and closed after session end.
In case of the channels i/o error ZeroVM will not start. ZeroVM preallocates
specified byte size for the local writable channels (this can be changed with
-P switch, see zerovm_switches.txt).

Network (socket based) channels
-------------------------------
All socket based channels are either sequential read only or sequential write
only. They represent unidirectional connection between two ZeroVM instances.
You can have as many network channels as you want, although it's not advisable
to have more than one channel in the same direction between the same two
ZeroVM instances. All network channels use unix domain sockets through network
broker (separate program). Write only channel will listen on socket while the
read only channel will connect to the same socket from another instance. All
the read operations on the guest side will block until some data is available.
If you read a specific amount of data (using pread() for example) the read
will block until this amount of data is available. There is no support for
unblocking reads for ZeroVM channels, it's by design.

Example of bidirectional connection between two ZeroVM instances:

Instance #1
Channel = ipc:12345, /dev/out/instance2, 0, 0, 0, 100, 1000
Node = 54321

Instance #2
Channel = ipc:54321, /dev/in/instance1, 0, 100, 1000, 0, 0
Node = 12345

Each read from read only network channel can result in zvm_eof indicator read.
This means that the other party closed the channel, you will get the same
zvm_eof each time you try to read from this channel again.

note: "ipc:" is a prefix and only way to mark the channel as "network" one.

Node identifiers
----------------
Node id and channel id (which is id of connected node) are not zerovm's
responsibility. Manifest provider and broker should have agreement about
node/channel naming convention. ZeroVM treat node id as a string.

If the manifest contains "Broker", "Node" and node identifier(s) in channel(s)
definition ZeroVM will do the following on startup:
1. open connection to broker using path specified by "Broker" value
2. mount channel(s) with node id in name field using "Node" from manifest and
   channel(s) definition to ask read or write only mode for the channel(s)

After these operations the channels will be set up with correct unidirectional
data paths. You can use zerovm networked samples to see the flow, namely
'netcopy' or 'demo/channels' sample. To find more info about broker consult
broker.txt

examples
-----------
Channel = /tmp/file.tmp, /dev/stderr, 0, 0, 0x100, 1048576
  will be mounted over "/tmp/file.tmp" file
  to "/dev/stderr" alias (visible to user)
  channel has sequential access
  channel is write only ("0, 0" in positions 5, 6 means no read possible)
  it is possible to make 256 writes (specified in position 7)
  it is possible to write 1048576 bytes (specified in position 8)

Channel = /dev/stdin, /dev/stdin, 0, 07, 0x1000, 0, 0
Channel = 55431, /dev/in/some_host, 0, 0x1000000, 0x100000000, 0, 0
Channel = 12345, /dev/out/node13, 0, 0, 0, 13, 1313

Limitations
-----------
- The number of channels in the manifest is limited to 10915 "Channel" lines
- user program cannot use network channel to itself
